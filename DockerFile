# Assuming the root of your repository is 'project-folder'
# Your current directory when building Docker is 'project-folder'

# --- Stage 1: Build the application ---
FROM node:20-alpine as build

# Set the working directory to the subfolder where your files are located
WORKDIR /app/server 

# Copy package.json and package-lock.json from the host path (server/) 
# to the container path (/app/server)
COPY server/package*.json ./

# Install production dependencies
RUN npm ci --only=production

# Copy the rest of your server files from the host path (server/) 
# to the container path (/app/server)
COPY server/ .

# --- Stage 2: Create the final runtime image ---
FROM node:20-alpine as runtime

# Set the working directory to the *same* subfolder
WORKDIR /app/server 

# Create a non-root user for security best practices
RUN addgroup --system appgroup && adduser --system --ingroup appgroup appuser
USER appuser

# Copy only the necessary files from the build stage (node_modules)
COPY --from=build /app/server/node_modules ./node_modules
# Copy application code from the build stage
COPY --from=build /app/server .

# Expose the port your application listens on (e.g., 3000)
EXPOSE 3000

# Define the command to run your application
# Ensure 'server.js' matches your main file name, or change to 'npm start'
CMD ["node", "server.js"]
